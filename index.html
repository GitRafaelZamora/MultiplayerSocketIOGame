<!DOCTYPE html>
<html>
<head>
	<title>Platform Game</title>
	<script src="phaser.js"></script>
	<script src="jquery.js"></script>
</head>
<body style="margin: 0 auto;">

	<script type="text/javascript">

		

		var map;
		var layer;
		var player;
		var cursors;
		var platforms;
		var collector = false;
		var height = 560, width = 1008;


		var game = new Phaser.Game(
			width, height, 
			Phaser.AUTO, 
			'phaser', 
			{ preload: preload, create: create, update: update }
		);
		$(window).resize(
			function() { 
				window.resizeGame(); 
			} 
		);

		function resizeGame () {
 
		  var height = window.innerHeight;
		  var width = window.innerWidth;
		 
		  game.width = width;
		  game.height = height;
		  game.stage.bounds.width = width;
		  game.stage.bounds.height = height;
		 
		  if (game.renderType === 1) {
		    game.renderer.resize(width, height);
		    Phaser.Canvas.setSmoothingEnabled(game.context, false);
		  }
		}

		function preload() {
			game.load.tilemap('world', 'assets/tilemaps/maps/world_map.json', null, Phaser.Tilemap.TILED_JSON);
			game.load.image('tiles', 'assets/tilemaps/tiles/world_tiles.png');
			game.load.spritesheet('character', 'assets/dude.png', 32, 48);
		}

		function create() {
			game.physics.startSystem(Phaser.Physics.ARCADE);
			game.stage.backgroundColor = '#787878';
			createMap();
			createPlayer();
		    cursors = game.input.keyboard.createCursorKeys();
		}

		function createPlayer() {
			player = game.add.sprite(32, game.world.height - 150, 'character');
			player.anchor.set(0.5);
			game.physics.enable(player);
			player.body.gravity.y = 900;
			player.body.collideWorldBounds = true;

			player.animations.add('left', [0,1,2,3], 10, true);
			player.animations.add('right', [5,6,7,8], 10, true);
			player.scale.setTo(.6,.6);
		}

		function createMap() {
			map = game.add.tilemap('world');
			map.addTilesetImage('world_tileset', 'tiles');
			map.setCollisionBetween(466, 466, true, 'world_layer');
			map.setCollisionBetween(335, 335, true, 'world_layer');
			map.setTileIndexCallback(179, collectBox, this);
			map.setTileIndexCallback(178, depositBox, this);
			layer = map.createLayer('world_layer');
			layer.resizeWorld();
		}

		function collectBox(sprite, tile) {
			if (!collector && tile.index !== -1) {
				tile.alpha = 0.2;
				tile.index = 0;
				layer.dirty = true;
				collector = true;
			}
			return false;
		}

		function depositBox(sprite, tile) {
			if (collector && tile.index !== -1) {
				tile.alpha = 0.2;
				tile.index = -1;
				layer.dirty = true;
				collector = false;
			}
			return false;
		}

		function update() {
			var hitPlatform = game.physics.arcade.collide(player, layer);
			player.body.velocity.x = 0;
		    if (cursors.right.isDown) {
		        player.body.velocity.x = 150;
		        player.animations.play('right');
		    } else if (cursors.left.isDown) {
		        player.body.velocity.x = -150;
		        player.animations.play('left');
		    } else if (cursors.down.isDown) {
		        player.body.velocity.y = 150;
		    } else {
		    	player.animations.stop();
		    	player.frame = 4;
		    }
		    // Jump Mechanics
		    if (cursors.up.isDown && hitPlatform && player.body.blocked.down) {
		        player.body.velocity.y = -380;
		    }

		}
	</script>
</body>
</html>